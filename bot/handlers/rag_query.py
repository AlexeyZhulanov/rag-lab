import asyncio
import ollama
from aiogram import types, F, Router
from bot import bot
from rag.chroma import search_in_db
from rag.llm import expand_query
from config import CHAT_MODEL

router = Router()

# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (RAG)
@router.message(F.text)
async def handle_question(message: types.Message):
    user_text = message.text
    await bot.send_chat_action(chat_id=message.chat.id, action="typing")

    # 1. –†–∞—Å—à–∏—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å (–¥–µ–ª–∞–µ–º —ç—Ç–æ –≤ –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞)
    expanded_query = await asyncio.to_thread(expand_query, user_text)
    print(f"DEBUG: –û—Ä–∏–≥–∏–Ω–∞–ª: '{user_text}' -> –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π: '{expanded_query}'")

    # 2. –ò—â–µ–º –≤ –±–∞–∑–µ —É–∂–µ –ø–æ –†–ê–°–®–ò–†–ï–ù–ù–û–ú–£ –∑–∞–ø—Ä–æ—Å—É
    found_text, meta = await asyncio.to_thread(search_in_db, expanded_query)

    if not found_text:
        await message.answer("ü§∑‚Äç‚ôÇÔ∏è –Ø –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π —Å–∫–∏–Ω—É—Ç—å –º–Ω–µ —Å—Ç–∞—Ç—å—é –Ω–∞ —ç—Ç—É —Ç–µ–º—É.")
        return

    # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç (–ø–æ–¥–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
    prompt = f"""
    –¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ –¥–∞–Ω–Ω—ã—Ö. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å, –æ–ø–∏—Ä–∞—è—Å—å –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–π –Ω–∏–∂–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
    –ö–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç—Ä—ã–≤–∫–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

    –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
    1. –°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏ –≤ —Ç–µ–∫—Å—Ç–µ —Ü–∏—Ç–∞—Ç—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –æ—Ç–≤–µ—Ç.
    2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç, —á–µ—Å—Ç–Ω–æ –Ω–∞–ø–∏—à–∏: "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏".
    3. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫–∏–π –∏ —á–µ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤.

    –ö–æ–Ω—Ç–µ–∫—Å—Ç:
    {found_text}

    –í–æ–ø—Ä–æ—Å: {user_text}
    """

    response = ollama.chat(model=CHAT_MODEL, messages=[{'role': 'user', 'content': prompt}],
        options={
            'temperature': 0.1,  # –ú–∏–Ω–∏–º—É–º —Ñ–∞–Ω—Ç–∞–∑–∏–∏
            'num_ctx': 8192  # –ë–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏
        }
    )

    answer = response['message']['content']

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –±–æ—Ç –æ—Ç–∫–∞–∑–∞–ª—Å—è –æ—Ç–≤–µ—á–∞—Ç—å
    refusal_phrases = ["–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", "–Ω–µ –∑–Ω–∞—é", "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ", "–∑–∞—Ç—Ä—É–¥–Ω—è—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å"]
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç–æ–ø-—Ñ—Ä–∞–∑–∞ –≤ –Ω–∞—á–∞–ª–µ –æ—Ç–≤–µ—Ç–∞ (–≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ)
    is_refusal = any(phrase in answer.lower() for phrase in refusal_phrases)

    if is_refusal:
        # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –∑–Ω–∞–µ—Ç, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ —Å—Å—ã–ª–∫–∏
        await message.answer(answer)
    else:
        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∏–ª –ø–æ –¥–µ–ª—É - –¥–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
        full_answer = f"{answer}\n\nüìö *–ò—Å—Ç–æ—á–Ω–∏–∫:* [{meta['title']}]({meta['url']})"
        await message.answer(full_answer, parse_mode="Markdown")